version: "2.1"

services:
  realtimedb:
    image: ${REPOSITORY}sofia2/realtimedb:${IMAGETAG}
    container_name: realtimedb
    networks:
      - datanetwork
    ports:
      - "27017:27017"
  configdb:
    image: ${REPOSITORY}sofia2/configdb:${IMAGETAG}
    container_name: configdb
    networks:
      - datanetwork
    ports:
      - "3306:3306"
    depends_on:
     - "realtimedb"
    healthcheck:
     test: "/usr/bin/mysql --user=root --execute \"SHOW DATABASES;\""
     interval: 4s
     timeout: 2s
     retries: 20       
  schedulerdb:
    image: ${REPOSITORY}sofia2/schedulerdb:${IMAGETAG}
    container_name: schedulerdb
    networks:
      - datanetwork
    ports:
      - "3307:3306"
    depends_on:
     - "configdb"           
  quasar:
    image: ${REPOSITORY}sofia2/quasar:${IMAGETAG}
    container_name: quasar
    networks:
     - datanetwork
    ports:
     - "18200:10800"
    environment:
     - REALTIMEDB=realtimedb 
    depends_on:
     - "realtimedb"
     - "configdb"   
  configinit:
    image: ${REPOSITORY}sofia2/configinit:${IMAGETAG}
    container_name: configinit
    networks:
     - datanetwork
    ports:
     - "18081:18081"
    build: .     
    depends_on:
     configdb: 
       condition: service_healthy         
networks:
  datanetwork:
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
