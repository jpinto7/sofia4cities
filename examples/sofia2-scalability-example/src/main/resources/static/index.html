<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Load Testing Tool</title>
	<script src="js/jquery-3.3.1.min.js"></script>
	<link rel="stylesheet" type="text/css" href="css/scalability.css">
</head>
<body>
	<div class="head">
		<h1>Load Testing Tool</h1>
	</div>
	
	<div>
		<div class="connection block">
			<div class="block-cell">
	    		<label for="token">Token:</label>
	    		<input class="token" name="token" value="008215e3580f4876bd7a301abc483664"/>
	    	</div>
	    	<div class="block-cell">
	    		<label for="clientPlatform">Device template:</label>
	    		<input class="clientPlatform" name="clientPlatform" value="Thermometer"/>
	    	</div>
	    	<div class="block-cell">
	    		<label for="clientPlatformInstance">Device:</label>
	    		<input class="clientPlatformInstance" name="clientPlatformInstance" value="Thermometer-Room-1"/>
	    	</div>
	    	<div class="block-cell">
	    		<label for="ontology">Ontology:</label>
	    		<input class="ontology" name="ontology" value="thermometer"/>
	    	</div>    		
		</div>
		<div class="block">
			<div class="block-cell">
				<div>
					<label for="rest-url">Rest URL:</label>
	    			<input class="rest-url url" name="rest-url" value="http://localhost:19000/iotbroker/"/>
				</div>
				<div>
					<label for="mqtt-url">MQTT URL:</label>
	    			<input class="mqtt-url url" name="mqtt-url" value="ssl://localhost:8883"/>
				</div>
				<div>
					<label for="kafka-url">KAFKA URL:</label>
	    			<input class="kafka-url url" name="kafka-url" value="localhost:9093"/>
				</div>
				<button class="btn-connect" onclick="btnConnect()">Store Values</button>
			</div>
			<div class="block-cell">
				<label for="instance">Instance json:</label>
				<textarea class="instance json" name="instance" rows="5" id="instance">{"temperature":{ "value": 25}}</textarea>
				
				<!--  input class="instance json" name="instance" value='{"temperature":{ "value": 25}}'/-->
			</div>
		</div>
		<div class="block">
			<label>session: </label>
			<span class="session">disconnected</span>
		</div>
		
		<div class="block">
			<div>
				<button class="btn-add-injector" onClick="btnAddInjector()">Add Injector</button>
				<button class="btn-refresh-status" onClick="btnRefresh()">Refresh Status</button>
				<select class="combo-protocol">
					<option value="rest">Rest</option>
				 	<option value="mqtt">MQTT</option>
				 	<option value="kafka">KAFKA</option>
				</select>
			</div>
			<div class="injectors inj-table">
				<div class="inj-totals">
					<div class="inj-cell-total-name inj-cell inj-cell-total">Total:</div>
					<div class="inj-cell-total-protocol inj-cell inj-cell-total"></div>
					<div class="inj-cell-total-status inj-cell inj-cell-total"></div>
					<div class="inj-cell-total-sent inj-cell inj-cell-total"></div>
					<div class="inj-cell-total-ok inj-cell inj-cell-total"></div>
					<div class="inj-cell-total-error inj-cell inj-cell-total"></div>
					<div class="inj-cell-total-throughput inj-cell inj-cell-total"></div>
					<div class="inj-cell-total-timeAlive inj-cell inj-cell-total"></div>
					<div class="inj-cell-total-throughputPeriod inj-cell inj-cell-total"></div>		
				</div>
				<div class="inj-header">
					<div class="inj-cell-name inj-cell">Injector</div>
					<div class="inj-cell-protocol inj-cell">Protocol</div>
					<div class="inj-cell-status inj-cell">Status</div>
					<div class="inj-cell-sent inj-cell">Sent</div>
					<div class="inj-cell-ok inj-cell">Correct</div>
					<div class="inj-cell-error inj-cell">Errors</div>
					<div class="inj-cell-throughput inj-cell">Inserts per second</div>
					<div class="inj-cell-timeAlive inj-cell">Time alive (s)</div>
					<div class="inj-cell-throughputPeriod inj-cell">Inserts per second last refresh</div>
				</div>
			</div>
		</div>
	</div>
	
	<div></div>

	<script>
		var injectors = (function() {
			var number = 0;
			var injectorList = [];
			
			function createInjector(name, protocol) {
				var injector = {
					name: name,
					protocol: protocol,
					sent: 0,
					ok: 0,
					error: 0
				}
				return injector;
			}			
			function createInjectorStatus(name, status) {
				var injector = {
					name: name,
					protocol: status.protocol,
					sent: status.sent,
					ok: status.sent - status.errors,
					error: status.errors,
					throughput: status.throughput,
					timeAlive: status.timeAlive,
					throughputPeriod: status.throughputPeriod
				}
				return injector;
			}			
			return {
				getInjectors: function() {
					return injectorList;
				},
		    	add: function(protocol) {
		      		number += 1;
		      		injectorList.push(createInjector(number, protocol));
		    	},
		    	remove: function(index) {
		      		injectorList.splice(index, 1);
		    	},
		    	number: function() {
		      		return number;
		    	},
		    	load: function(injectors) {
		    		var i;
		    		injectorList = [];
		    		number = 0;
		    		for(i = 0; i< injectors.length; i++){
		    			injectorList.push(createInjectorStatus(injectors[i].id, injectors[i]));
		    			if (injectors[i].id > number){
		    				number = injectors[i].id;
		    			}
		    		}
		    	}
		  	}   
		})();
	
		function btnConnect(){
		
			var data = JSON.stringify({
				token: $(".token").val(),
				clientPlatform: $(".clientPlatform").val(),
				clientPlatformInstance: $(".clientPlatformInstance").val(),
				restURL: $(".rest-url").val(),
				mqttURL: $(".mqtt-url").val(),
				kafkaURL: $(".kafka-url").val(),
				ontology: $(".ontology").val()
			});
				
			$.ajax({
		        url: 'connection',
		        type: 'POST',
		        contentType: 'application/json',
		        data: data,
		        dataType: 'json',
		        success: function (response){
		        	var text = 'token:' + response.token + ', device template:' + response.clientPlatform + ', device:' + response.clientPlatformInstance + ', ontology:' + response.ontology;
	                $(".session").text(text);
	            },
	            error: function (xhr, ajaxOptions, thrownError) {
	            	$(".session").text(xhr.status);
	            }
		    });

		}
		
		function btnStart(injector) {
			var data = $("textarea#instance").val();

			var id = 'inj-' + injector;
			var status = $(".injector[id="+id+"]").find(".inj-cell-status");
			var protocol = $(".injector[id="+id+"]").find(".inj-cell-protocol").text();
			var ontology = $(".ontology").val();
			
			$.ajax({
		        url: 'startInjector?&injector='+injector+'&protocol='+protocol,
		        type: 'POST',
		        contentType: 'application/json',
		        data: data,
		        dataType: 'json',
		        success: function (response){
		        	status.text("RUNNING");
					status.css("color", "green");
	            },
	            error: function (xhr, ajaxOptions, thrownError) {
					status.text("ERROR");
					status.css("color", "red");
	            }
		    });			
		}
		function btnRemove(injector) {
			$.ajax({
		        url: 'stopInjector?injector='+injector,
		        type: 'GET',
		        dataType: 'json',
		        success: function (response){
		        	injectors.remove(injector-1);
		        	var injectorHtml = $('.injector[id="inj-'+injector+'"]');
		        	injectorHtml.remove();
	            },
	            error: function (xhr, ajaxOptions, thrownError) {
					alert("Error stoping injector")
	            }
		    });	
		}
		
		function btnAddInjector(){
			var protocol = $('.combo-protocol option:selected').val();
			injectors.add(protocol);
			var injs = injectors.getInjectors();
			var parent = createInjector(injectors.number(), injs[injs.length-1].protocol, injs[injs.length-1].sent, injs[injs.length-1].ok, injs[injs.length-1].error);
			var status = parent.find(".inj-cell-status");
			status.text("STOPPED");
			status.css("color", "orange");
			$(".injectors").append(parent);			
		}
		
		function btnRefresh(){
			$.ajax({
		        url: 'status',
		        type: 'GET',
		        dataType: 'json',
		        success: function (response){
		        	var i;
		        	var totals = {
		        			sent: 0,
		        			ok: 0,
		        			errors: 0,
		        			throughput: 0,
		        			throughputPeriod: 0,
		        			number: 0
		        	}
		        	for (i = 0; i < response.length; i++) { 
		        		var injector = $('.injector[id="inj-'+response[i].id+'"]');
		        		updateInjector(injector, response[i]);
		        		totals.sent = totals.sent + response[i].sent;
		        		totals.errors = totals.errors + response[i].errors;
		        		totals.ok = totals.ok + (totals.sent - totals.errors);
		        		totals.throughput = totals.throughput + response[i].throughput;
		        		totals.throughputPeriod = totals.throughputPeriod + response[i].throughputPeriod;
		        	}
		        	totals.number = i;
		        	updateTotals(totals);
	            },
	            error: function (xhr, ajaxOptions, thrownError) {
	            	console.log("Error obtaining status");
	            }
		    });
		}
		
		function updateInjector(injector, status){
    		injector.find('.inj-cell-sent').text(status.sent);
    		injector.find('.inj-cell-error').text(status.errors);
    		injector.find('.inj-cell-ok').text(status.sent - status.errors);
    		injector.find('.inj-cell-throughput').text(Math.round(status.throughput * 100) / 100);
    		injector.find('.inj-cell-timeAlive').text(status.timeAlive/1000);
    		injector.find('.inj-cell-throughputPeriod').text(Math.round(status.throughputPeriod * 100) / 100);
		}
		
		function updateTotals(totals){
			$('.inj-cell-total-protocol').text(totals.number);
			$('.inj-cell-total-sent').text(totals.sent);
    		$('.inj-cell-total-error').text(totals.errors);
    		$('.inj-cell-total-ok').text(totals.sent - totals.errors);
    		$('.inj-cell-total-throughput').text(Math.round(totals.throughput * 100) / 100);
    		$('.inj-cell-total-throughputPeriod').text(Math.round(totals.throughputPeriod * 100) / 100);
		}
		
		function createInjector(number, protocol, sent, ok, error, throughput, timeAlive, throughputPeriod){
			var injs = injectors.getInjectors();
			var parent = $('<div class="injector inj-row" id="inj-'+number+'""></div>');
			parent.append('<div class="inj-cell-name inj-cell">'+number+'</div>');
			parent.append('<div class="inj-cell-protocol inj-cell">'+protocol+'</div>');
			parent.append('<div class="inj-cell-status inj-cell"></div>');
			parent.append('<div class="inj-cell-sent inj-cell">'+sent+'</div>');
			parent.append('<div class="inj-cell-ok inj-cell">'+ok+'</div>');
			parent.append('<div class="inj-cell-error inj-cell">'+error+'</div>');
			parent.append('<div class="inj-cell-throughput inj-cell">'+Math.round(throughput * 100) / 100+'</div>');
			parent.append('<div class="inj-cell-timeAlive inj-cell">'+timeAlive+'</div>');
			parent.append('<div class="inj-cell-throughputPeriod inj-cell">'+Math.round(throughputPeriod * 100) / 100+'</div>');
			parent.append('<button class="inj-cell" onClick="btnStart('+number+')">Start</button>');
			parent.append('<button class="inj-cell" onClick="btnRemove('+number+')">Remove</button>');			
			return parent;
		}
		
		function loadInjectors(){
			$.ajax({
		        url: 'status',
		        type: 'GET',
		        dataType: 'json',
		        success: function (response){
		        	var i;
		        	injectors.load(response);
		        	var injs = injectors.getInjectors();
		        	var totals = {
		        			sent: 0,
		        			ok: 0,
		        			errors: 0,
		        			throughput: 0,
		        			throughputPeriod: 0,
		        			number: 0
		        	}
		        	for (i = 0; i < injs.length; i++) { 
		        		totals.sent = totals.sent + injs[i].sent;
		        		totals.ok = totals.ok + injs[i].ok;
		        		totals.errors = totals.errors + injs[i].error;
		        		totals.throughput = totals.throughput + injs[i].throughput;
		        		totals.throughputPeriod = totals.throughputPeriod + injs[i].throughputPeriod;
		        		var parent = createInjector(injs[i].name, injs[i].protocol, injs[i].sent, injs[i].ok, injs[i].error, injs[i].throughput, injs[i].timeAlive/1000, injs[i].throughputPeriod);		        		
		        		var status = parent.find(".inj-cell-status");
		    			status.text("RUNNING");
		    			status.css("color", "green");
		    			$(".injectors").append(parent);
		        	}
		        	totals.number = i;
		        	updateTotals(totals);
	            },
	            error: function (xhr, ajaxOptions, thrownError) {
	            	console.log("Error obtaining status");
	            }
		    });
		}
		
		function getDataConnection(){
			$.ajax({
		        url: 'getDataConnection',
		        type: 'GET',
		        dataType: 'json',
		        success: function (response){
		        	var text = 'token:' + response.token + ', device template:' + response.clientPlatform + ', device:' + response.clientPlatformInstance;	        	
	                $(".session").text(text);	                
	            },
	            error: function (xhr, ajaxOptions, thrownError) {
	            	if (xhr.status == 200){
	            		$(".session").text('Disconnected');
	            	} else {
	            		$(".session").text(xhr.status);
	            	}
	            	
	            }
		    });
		}
		
		$( document ).ready(function() {
			getDataConnection();
		    loadInjectors();
		});
		
		window.setInterval(function(){
			btnRefresh();
		}, 5000);
		
	</script>
</body>
</html>